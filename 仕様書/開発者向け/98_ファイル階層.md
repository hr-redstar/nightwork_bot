# ファイル階層

本ドキュメントでは、nightwork_botプロジェクトのファイル階層構造を説明します。

## プロジェクト全体構造

```
nightwork_bot/
├── src/                    # ソースコード
│   ├── index.js           # エントリーポイント
│   ├── botClient.js       # Discordクライアント初期化
│   ├── commands/          # スラッシュコマンド定義
│   ├── events/            # Discordイベントハンドラ
│   ├── handlers/          # 機能別インタラクションハンドラ
│   ├── modules/           # 機能モジュール
│   └── utils/             # ユーティリティ関数
├── 仕様書/                 # プロジェクト仕様書
│   ├── エンドユーザー向け/
│   └── 開発者向け/
└── local_data/            # ローカル開発用データ（開発環境のみ）
    └── GCS/               # GCSエミュレーション
```

## src/ ディレクトリ詳細

### commands/
スラッシュコマンドの定義ファイル。各ファイルは1つのコマンドを定義します。

```
commands/
├── 10_設定.js                      # /設定
├── 11_設定経費.js                  # /設定経費
├── 12_設定売上.js                  # /設定売上
├── 13_設定KPI.js                   # /設定KPI
├── 14_設定出退勤.js                # /設定出退勤
├── 15_設定店内状況_ひっかけ一覧.js # /設定店内状況_ひっかけ一覧
├── 16_設定接客ログ.js              # /設定接客ログ
├── 20_設定chat_gpt.js              # /設定chat_gpt
├── 90_メッセージ.js                # /メッセージ
├── 91_メッセージファイル化.js      # /メッセージファイル化
├── 97_ダイス.js                    # /ダイス
├── 98_設定くじ引き.js              # /設定くじ引き
└── 99_設定level.js                 # /設定level
```

**命名規則**: `番号_機能名.js`
- 番号は機能のカテゴリを示す（10番台=設定系、90番台=その他）

### events/
Discordイベントのハンドラファイル。

```
events/
├── interactionCreate.js   # インタラクション（ボタン、メニュー、モーダル）のルーティング
├── messageCreate.js        # メッセージ受信イベント
├── ready.js                # Bot起動完了イベント
└── ...
```

### handlers/
各機能のインタラクション処理を担当するハンドラ。機能ごとにディレクトリまたはファイルで分割。

```
handlers/
├── commandHandler.js           # コマンド実行ハンドラ
├── configBotHandler.js         # 設定機能のルートハンドラ
├── keihiBotHandler.js          # 経費機能のルートハンドラ
├── syutBotHandler.js           # 出退勤機能のルートハンドラ
├── tennai_hikkakeBotHandler.js # 店内状況・ひっかけのルートハンドラ
├── kuzibikiBotHandler.js       # くじ引き機能のルートハンドラ（旧）
├── chat_gptBotHandler.js       # ChatGPT機能のルートハンドラ
│
├── keihi/                      # 経費機能の詳細実装
│   ├── index.js               # 経費機能のルーター
│   ├── setting/               # 設定パネル関連
│   │   ├── index.js          # 設定系ルーター
│   │   ├── panel.js          # パネル表示
│   │   ├── approver.js       # 承認者設定
│   │   ├── csv.js            # CSV出力
│   │   └── ...
│   └── request/               # 申請・承認フロー
│       ├── index.js          # 申請系ルーター
│       ├── requestModal.js   # 申請モーダル処理
│       ├── action_approve.js # 承認処理
│       ├── action_modify.js  # 修正処理
│       └── action_delete.js  # 削除処理
│
├── uriage/                     # 売上機能の詳細実装
│   ├── index.js               # 売上機能のルーター
│   ├── setting/               # 設定パネル関連
│   └── report/                # 報告フロー
│
├── KPI/                        # KPI機能の詳細実装
│   ├── index.js               # KPIルーター
│   ├── KPISetupHandler.js     # 設定処理
│   ├── applyHandlers.js       # 申請処理
│   └── ...
│
├── syut/                       # 出退勤機能の詳細実装
│   ├── syutHandler_Cast.js    # キャスト出退勤処理
│   ├── syutHandler_Kuro.js    # 黒服出退勤処理
│   ├── syutPanel_Cast.js      # キャストパネル
│   ├── syutPanel_Kuro.js      # 黒服パネル
│   ├── syutPanel_config.js    # パネル設定
│   └── ...
│
├── tennai_hikkake/             # 店内状況・ひっかけ機能
│   ├── hikkakeSetup.js        # セットアップフロー
│   ├── hikkakeReport.js       # 報告処理
│   ├── tennaiPanel.js         # パネル表示
│   └── ...
│
├── kuzibiki/                   # くじ引き機能の詳細実装
│   ├── kuzibikiPanel.js       # パネル表示
│   ├── kuzibikiPanelHandler.js # パネル操作ハンドラ
│   ├── kuzibikiExecute.js     # くじ引き実行
│   └── ...
│
├── config/                     # 設定機能の詳細実装
│   ├── configLogger.js        # 設定ログ出力
│   ├── storeConfig.js         # 店舗設定
│   └── ...
│
└── chat_gpt/                   # ChatGPT機能の詳細実装
    └── ...
```

**階層ルール**:
1. **ルートハンドラ**: `{機能名}BotHandler.js` - 機能全体のエントリーポイント
2. **機能ディレクトリ**: `{機能名}/` - 複雑な機能は専用ディレクトリに分割
3. **サブディレクトリ**: `setting/`, `request/`, `report/` など - 機能内の役割で分類

### modules/
再利用可能な機能モジュール。handlersよりも汎用的な処理を含む。

```
modules/
├── kpi/
│   ├── setting/
│   │   ├── sendKpiSettingPanel.js
│   │   └── settingActions.js
│   └── ...
└── common/
    └── utils/
```

### utils/
ユーティリティ関数とヘルパー。機能ごとに分類。

```
utils/
├── gcs.js                  # GCS操作の共通関数
├── logger.js               # ログ出力
├── errorHandlers.js        # エラーハンドリング
├── config/                 # 設定管理ユーティリティ
│   ├── gcsConfigManager.js
│   ├── configAccessor.js
│   └── ...
├── keihi/                  # 経費関連ユーティリティ
│   ├── keihiConfigManager.js
│   └── ...
├── uriage/                 # 売上関連ユーティリティ
├── syut/                   # 出退勤関連ユーティリティ
│   └── syutConfigManager.js
├── kuzibiki/               # くじ引き関連ユーティリティ
│   └── kuzibikiStorage.js
├── tennai_hikkake/         # 店内状況関連ユーティリティ
│   └── gcsTennaiHikkake.js
└── ...
```

## データ保存構造（GCS）

開発環境: `local_data/GCS/{ギルドID}/`
本番環境: `GCS_BUCKET_NAME/{ギルドID}/`

```
{ギルドID}/
├── config/
│   ├── config.json                    # 全体設定
│   └── 店舗_役職_ロール.json          # 店舗・役職マッピング
├── keihi/                             # 経費データ
│   ├── config.json
│   └── {店舗名}/
│       ├── config.json
│       └── {年}/{月}/{日}/
│           ├── {年月日}.json
│           └── {年月日}.csv
├── uriage/                            # 売上データ
│   └── ...
├── kpi/                               # KPIデータ
│   └── ...
├── syut/                              # 出退勤データ
│   └── ...
├── tennai_hikkake/                    # 店内状況データ
│   ├── config.json
│   └── {店舗名}/
│       ├── 店内状況.json
│       ├── ひっかけ一覧.json
│       └── 接客ログ.json
├── kuzibiki/                          # くじ引きデータ
│   ├── config.json
│   └── 履歴/
│       └── {年月日}.json
└── chatgpt/                           # ChatGPTデータ
    └── ...
```

## 命名規則サマリー

- **コマンドファイル**: `番号_機能名.js`
- **ルートハンドラ**: `{機能名}BotHandler.js`
- **機能ディレクトリ**: `{機能名}/`
- **設定ファイル**: `config.json` または `{機能名}Config.js`
- **パネルファイル**: `{機能名}Panel.js`
- **ユーティリティ**: `{機能名}ConfigManager.js`, `{機能名}Storage.js`

詳細な命名ルールについては、[99_ファイル命名・階層ルール.md](./99_ファイル命名・階層ルール.md)を参照してください。
