name: Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆDiscordã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²ï¼‹å¤ã„ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤ï¼‰

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  workflow_dispatch:

env:
  PROJECT_ID: nightwork-bot
  SERVICE_NAME: nightwork-bot
  REGION: asia-northeast1
  GAR_LOCATION: asia-northeast1
  REPOSITORY: nightwork-bot
  REGISTRY: asia-northeast1-docker.pkg.dev
  MAX_IMAGES_KEEP: 5

jobs:
  deploy:
    name: Cloud Run ãƒ“ãƒ«ãƒ‰ï¼†ãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

    steps:
      - name: ğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ§© Node.js ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ğŸª„ Discord ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²
        run: node scripts/deployGlobalCommands.js
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          NODE_ENV: production

      - name: ğŸ” GCP èªè¨¼
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: â˜ï¸ gcloud SDK ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸ§¾ Artifact Registry èªè¨¼
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: ğŸ•’ ãƒ“ãƒ«ãƒ‰æƒ…å ±ã®æº–å‚™
        run: |
          echo "BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "SHORT_SHA=${GITHUB_SHA::8}" >> $GITHUB_ENV

      - name: ğŸ—ï¸ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼†push
        run: |
          IMAGE_TAG="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:${SHORT_SHA}"
          LATEST_TAG="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:latest"

          docker build \
            --build-arg BUILDTIME="${BUILD_TIME}" \
            --build-arg COMMIT_SHA="${GITHUB_SHA}" \
            -t "${IMAGE_TAG}" \
            -t "${LATEST_TAG}" .

          docker push "${IMAGE_TAG}"
          docker push "${LATEST_TAG}"

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: ğŸ§¹ å¤ã„ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤ï¼ˆæœ€æ–° $MAX_IMAGES_KEEP ä»¶ã‚’æ®‹ã™ï¼‰
        run: |
          echo "å¤ã„ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ä¸­..."
          IMAGES=$(gcloud artifacts docker images list ${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME} \
            --format='value(TAGS,CREATE_TIME)' | sort -k2)

          COUNT=0
          while IFS= read -r line; do
            COUNT=$((COUNT+1))
            if [ $COUNT -le $MAX_IMAGES_KEEP ]; then
              continue
            fi
            TAGS=$(echo $line | awk '{print $1}')
            IFS=',' read -ra TAG_ARRAY <<< "$TAGS"
            for TAG in "${TAG_ARRAY[@]}"; do
              echo "å‰Šé™¤å¯¾è±¡ã‚¤ãƒ¡ãƒ¼ã‚¸: $TAG"
              gcloud artifacts docker images delete ${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:$TAG --quiet
            done
          done <<< "$IMAGES"

      - name: ğŸš€ Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          ENV_VARS="NODE_ENV=production,TZ=Asia/Tokyo,BUILD_TIME=${BUILD_TIME},COMMIT_SHA=${GITHUB_SHA},REGISTRY_TYPE=artifact-registry,DISCORD_TOKEN=${DISCORD_TOKEN},GCS_BUCKET_NAME=${GCS_BUCKET_NAME},CLIENT_ID=${CLIENT_ID},AUTO_DEPLOY_COMMANDS=true,GCP_SA_KEY=${GCP_SA_KEY}"

          gcloud run deploy ${SERVICE_NAME} \
            --image ${IMAGE_TAG} \
            --region ${REGION} \
            --platform managed \
            --allow-unauthenticated \
            --ingress all \
            --set-env-vars "${ENV_VARS}" \
            --cpu 1 \
            --memory 2Gi \
            --min-instances 1 \
            --max-instances 1 \
            --port 8080 \
            --timeout 900 \
            --concurrency 80 \
            --execution-environment gen2 \
            --verbosity debug \
            --quiet

      - name: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤çµæœç¢ºèª
        run: |
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region ${REGION} \
            --format 'value(status.url)')
          echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
          echo "ğŸŒ ã‚µãƒ¼ãƒ“ã‚¹URL: ${SERVICE_URL}"
          echo "ğŸ“¦ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸: ${IMAGE_TAG}"
          echo "ğŸ•’ ãƒ“ãƒ«ãƒ‰æ™‚åˆ»: ${BUILD_TIME}"
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${GITHUB_SHA}"
